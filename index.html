<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="manifest" href="manifest.json">
		<title>Mine</title>
	</head>

	<body style="background: #555">
		<canvas id="Ganvas" style="top:0px;left:0px"></canvas>
		<input type="button" onclick="init(10,10,10)" value="LEVEL 1" style="bottom: 0px;position: absolute;left: 10%">
		<input type="button" onclick="init(20,20,40)" value="LEVEL 2" style="bottom: 0px;position: absolute;left:40%">
		<input type="button" onclick="init(30,30,100)" value="LEVEL 3" style="bottom: 0px;position: absolute;left:70%">
		<script>
//service worker
if ('serviceWorker' in navigator) {
	navigator.serviceWorker.register('sw.js').then(function (registration) {
		console.log('OK: ', registration.scope);
	}).catch(function (err) {
		console.log('FAILED: ', err);
	});
}

// Core version
var gameover = false, clear = false, field;
function initGame(w, h, m) {
	field = [];
	gameover = false;
	clear = false;
	for (var i = 0; i < h; i++) {
		field[i] = [];
		for (var j = 0; j < w; j++)
			field[i][j] = 10;
	}
	var count = 0;
	while (count < m) {
		for (var i = 0; i < h; i++)
			for (var j = 0; j < w; j++) {
				if (count > m) continue;
				if (Math.random() > 0.99) { field[i][j] = 9; count++; }
			}
	}
}
function open(x, y) {
	if (gameover) return 1;//gameover
	if (check()) return 2;//cleared
	if (field[y][x] == 9) { gameover = true; return 1; }//bomb
	var count = 0;
	for (var i = -1; i <= 1; i++) {
		if (y + i < field.length && y + i >= 0)
			for (var j = -1; j <= 1; j++)
				if (x + j < field[0].length && x + j >= 0)
					if (field[y + i][x + j] == 9) count++;
	}
	field[y][x] = count;
	if (count == 0) {
		for (var i = -1; i <= 1; i++) {
			if (y + i < field.length && y + i >= 0)
				for (var j = -1; j <= 1; j++)
					if (x + j < field[0].length && x + j >= 0 && (i != 0 | j != 0))
						if (field[y + i][x + j] > 9)
							setTimeout(open(x + j, y + i), true);
		}
	}
}
function check() {
	if (gameover) return false;
	for (var i = 0; i < field.length; i++)
		for (var j = 0; j < field[i].length; j++)
			if (field[i][j] > 9) return false;
	return true;
}
// GUI version

var canvas = document.getElementById("Ganvas");
var ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight * 0.8;

canvas.addEventListener("click", function (e) {
	var TILEW, TILEH;
	TILEW = (canvas.width - e.target.getBoundingClientRect().left) / (field[0].length + 1);
	TILEH = (canvas.height - e.target.getBoundingClientRect().top) / (field.length + 1);
	var mx = e.clientX - e.target.getBoundingClientRect().left - TILEW / 2;
	var my = e.clientY - e.target.getBoundingClientRect().top - TILEH / 2;
	var x = Math.floor(mx / TILEW);
	var y = Math.floor(my / TILEH);
	console.log(x, y);
	if (y >= 0 && y < field.length && x >= 0 && x < field[0].length)
		open(x, y);
	draw(TILEW, TILEH);
	if (check() && !clear) { clear = true; alert("CLEAR!!") }
});
function draw(TILEW, TILEH) {

	var color = ["#7f0", "#09d", "#0d0", "#ff0", "#f70", "#f0f", "#0ff"];

	ctx.fillStyle = "#555";
	ctx.font = "Serif 10px"
	ctx.rect(0, 0, canvas.width, canvas.height);
	ctx.fill();
	for (var i = 0; i < field.length; i++) {
		for (var j = 0; j < field[i].length; j++) {
			if (field[i][j] < 9 && field[i][j] != 0 /*number*/) {
				ctx.beginPath();
				ctx.fillStyle = color[field[i][j] - 1];
				ctx.fillText(field[i][j], j * TILEW + TILEW, i * TILEH + TILEH);
				ctx.fill();
			}
			if (gameover && field[i][j] == 9 /*show bomb*/) {
				ctx.beginPath();
				ctx.fillStyle = "#333";
				ctx.rect(TILEW * j + TILEW / 2 + 1, TILEH * i + TILEH / 2 + 1, TILEW - 2, TILEH - 2);
				ctx.fill();

				ctx.beginPath();
				ctx.fillStyle = "#f00";
				if (TILEW < TILEH)
					ctx.arc(TILEW * j + TILEW, TILEH * i + TILEH, TILEW / 3, 0, 7);
				else
					ctx.arc(TILEW * j + TILEW, TILEH * i + TILEH, TILEH / 3, 0, 7);
				ctx.fill();
			} else if (field[i][j] > 8) {
				ctx.beginPath();
				ctx.fillStyle = "#333";
				ctx.rect(TILEW * j + TILEW / 2 + 1, TILEH * i + TILEH / 2 + 1, TILEW - 2, TILEH - 2);
				ctx.fill();
			}
		}
	}
}
function init(w, h, m) {
	initGame(w, h, m);
	draw((canvas.width - canvas.offsetLeft) / (field[0].length + 1), (canvas.height - canvas.offsetTop) / (field[0].length + 1))
}
init(10, 10, 10);
		</script>
	</body>

</html>
